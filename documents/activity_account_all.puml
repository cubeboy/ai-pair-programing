@startuml Activity Diagram - Account Management

!theme plain
title 회계 관리 솔루션 - 계정과목 관리 액티비티 다이어그램

|Client|
start
:클라이언트 요청;

|System|
if (요청 타입 확인) then (계정 생성)
    :CreateAccountRequest 수신;
    :CreateAccountCommand 생성;
    
    |AccountService|
    :계정코드 중복 검사;
    if (계정코드 중복?) then (yes)
        :예외 발생\n"계정코드 이미 존재";
        |Client|
        :400 Bad Request 응답;
        stop
    else (no)
        if (상위계정 지정?) then (yes)
            :상위계정 조회;
            if (상위계정 존재?) then (no)
                :예외 발생\n"상위계정 없음";
                |Client|
                :400 Bad Request 응답;
                stop
            else (yes)
                if (상위계정 활성?) then (no)
                    :예외 발생\n"비활성 상위계정";
                    |Client|
                    :400 Bad Request 응답;
                    stop
                endif
            endif
        endif
        
        :Account 도메인 객체 생성;
        :AccountRepository를 통해 저장;
        
        |Infrastructure|
        :AccountJpaEntity로 변환;
        :데이터베이스에 저장;
        :ID 자동 생성;
        :저장된 엔티티 반환;
        
        |AccountService|
        :Account 도메인 객체로 변환;
        
        |AccountController|
        :AccountResponse로 변환;
        
        |Client|
        :201 Created 응답;
    endif

elseif (계정 조회) then
    if (단일 계정 조회?) then (yes)
        :계정 ID로 조회;
        
        |AccountService|
        :AccountRepository를 통해 조회;
        
        |Infrastructure|
        :데이터베이스에서 조회;
        
        if (계정 존재?) then (no)
            |AccountService|
            :예외 발생\n"계정 없음";
            |Client|
            :404 Not Found 응답;
            stop
        else (yes)
            |Infrastructure|
            :Account 도메인 객체로 변환;
            
            |AccountController|
            :AccountResponse로 변환;
            
            |Client|
            :200 OK 응답;
        endif
        
    else (목록 조회)
        if (타입별 조회?) then (yes)
            :AccountType으로 필터링;
        else (no)
            :활성 계정 전체 조회;
        endif
        
        |AccountService|
        :AccountRepository를 통해 조회;
        
        |Infrastructure|
        :데이터베이스에서 목록 조회;
        :Account 도메인 객체 리스트로 변환;
        
        |AccountController|
        :AccountResponse 리스트로 변환;
        
        |Client|
        :200 OK 응답;
    endif

elseif (계정 수정) then
    :UpdateAccountRequest 수신;
    :UpdateAccountCommand 생성;
    
    |AccountService|
    :기존 계정 조회;
    
    if (계정 존재?) then (no)
        :예외 발생\n"계정 없음";
        |Client|
        :404 Not Found 응답;
        stop
    else (yes)
        if (상위계정 변경?) then (yes)
            :새 상위계정 조회;
            if (상위계정 존재?) then (no)
                :예외 발생\n"상위계정 없음";
                |Client|
                :400 Bad Request 응답;
                stop
            else (yes)
                if (상위계정 활성?) then (no)
                    :예외 발생\n"비활성 상위계정";
                    |Client|
                    :400 Bad Request 응답;
                    stop
                else (yes)
                    if (자기 참조?) then (yes)
                        :예외 발생\n"자기 자신을 상위계정으로 설정";
                        |Client|
                        :400 Bad Request 응답;
                        stop
                    endif
                endif
            endif
        endif
        
        :계정 정보 업데이트;
        :AccountRepository를 통해 저장;
        
        |Infrastructure|
        :AccountJpaEntity로 변환;
        :데이터베이스 업데이트;
        :Account 도메인 객체로 변환;
        
        |AccountController|
        :AccountResponse로 변환;
        
        |Client|
        :200 OK 응답;
    endif

else (계정 비활성화)
    :계정 ID 수신;
    
    |AccountService|
    :계정 조회;
    
    if (계정 존재?) then (no)
        :예외 발생\n"계정 없음";
        |Client|
        :404 Not Found 응답;
        stop
    else (yes)
        :하위 계정 조회;
        if (하위 계정 존재?) then (yes)
            :예외 발생\n"하위 계정 존재";
            |Client|
            :400 Bad Request 응답;
            stop
        else (no)
            :계정 비활성화;
            :AccountRepository를 통해 저장;
            
            |Infrastructure|
            :AccountJpaEntity로 변환;
            :데이터베이스 업데이트\n(is_active = false);
            :Account 도메인 객체로 변환;
            
            |AccountController|
            :AccountResponse로 변환;
            
            |Client|
            :200 OK 응답;
        endif
    endif
endif

|System|
:로그 기록;

|Client|
stop

@enduml
